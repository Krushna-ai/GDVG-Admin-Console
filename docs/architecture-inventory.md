# GDVG Admin Console - Architecture Inventory & Audit

> [!NOTE]  
> **Date:** 2026-02-22  
> This document provides a factual, verified breakdown of the entire architecture without assumptions or future-tense generalizations.

### üè∑Ô∏è Confidence Tags
| Tag | Description |
|---|---|
| `[VERIFIED]` | Directly observed in code, DB, or logs. |
| `[PARTIAL]` | Observed in code, but full scope or usage is incomplete. |
| `[ASSUMED]` | Inferred logically but not explicitly printed. |
| `[UNKNOWN]` | Not verified or missing. |

---

## üìÅ 1. REPOSITORY STRUCTURE `[VERIFIED]`

### Top-Level Directories
| Directory | Description |
|---|---|
| `.github/` | Contains Actions workflows for automated CI/CD and cron jobs. |
| `docs/` | Markdown documentation and architectural plans. |
| `public/` | Static assets (images, SVGs). |
| `python/` | Python scripts/packages typically used for custom data extraction and imports. |
| `scripts/` | TypeScript automated scripts (Enrichment, Parsing, Data Quality). |
| `src/` | Next.js frontend code (React components, App Router). |
| `supabase/` | Local Supabase edge functions, migrations, and database configs. |

### Key Workflows (`.github/workflows/`)
| Workflow | Trigger/Schedule | Purpose |
|---|---|---|
| `auto-enrichment-scheduled.yml` | `30 20 * * *` (Daily) | Automated daily enrichment pipeline across sources. |
| `auto-import-manual.yml` | Manual | Trigger for CSV/Kaggle import pipeline. |
| `auto-import-scheduled.yml` | `30 21 * * *` (Daily) | Nightly raw import batch runner. |
| `bulk-import.yml` | Triggers via workflow dispatch | Runs `bulk-import.ts`. |
| `data-quality.yml` | `30 22 * * *` (Daily) | Generates schema integrity reports and checks nulls. |
| `enrich-[entity].yml` | Manual / Dispatch | Discrete enrichment for collections, content, people. |
| `process-imports.yml` | Multiple | Orchestrator for `import_queue` processing. |
| `refresh-queue.yml` | Multiple | Orchestrator for maintaining queue states. |
| `sync-changes.yml` | `30 20 * * 0` (Weekly) | Delta TMDB sync logic. |

### Core Scripts (`scripts/`)
| Category | Script Name | Purpose |
|---|---|---|
| **Ingestion** | `auto-import.ts`, `bulk-import.ts`, `process-imports.ts` | Handles initial TMDB/Kaggle dataset parsing. |
| **Audit** | `data-quality-report.ts` | Audits Nulls and generates `quality_reports`. |
| **Enrichment** | `enrich-collections.ts`, `enrich-content.ts`, `enrich-people.ts`, `enrich-queue.ts`, `enrich-seasons.ts` | Extrapolates deep data across TMDB, Wikipedia, Wikidata. |
| **Orchestration** | `refresh-queue.ts`, `sync-changes.ts` | Polling mechanisms and database sync. |
| **Validation** | `validate-content.ts`, `validate-people.ts` | Typesafe TypeScript validators. |

### Script Libraries (`scripts/lib/`)
| Module Name | Purpose |
|---|---|
| `analytics.ts` | Reporting utility. |
| `api-logger.ts` | Core wrapper to capture API success/fail/time metrics into `api_usage_log`. |
| `cycle.ts` | Manages the `enrichment_cycles` table logic. |
| `database.ts` / `.types.ts` | TypeScript Interfaces mapping exactly to the Supabase Schema. |
| `enrich.ts` | Legacy/Helper payload logic. |
| `queue.ts` | Manages the `enrichment_queue` state. |
| `supabase.ts` | Simple `@supabase/supabase-js` client export. |
| `tmdb.ts`, `wikidata.ts`, `wikipedia.ts` | Explicit API wrappers carrying target logics and boundaries. |
| `wiki-parser.ts` | DOM parser mapping Wikipedia's robust standard HTML shapes. |

---

## üóÑÔ∏è 2. DATABASE SCHEMA (SUPABASE) `[VERIFIED]`

> [!TIP]
> *Row constraints extracted natively via `pg_stat_user_tables`.*

### Core Tables & Row Counts
| Table Name | Row Count | Purpose |
|---|---|---|
| **`import_queue`** | 493,365 | Raw scraped IDs pending processing |
| **`enrichment_queue`** | 59,490 | Entities pending deep Wiki/Cast appends |
| **`content`** | 10,985 | Master TMDB entity storage (Movies & TV) |
| **`people`** | 35 | Cast & Crew profiles |
| **`episodes`** | 22 | TV specific episodes |
| **`quality_reports`** | 15 | Diagnostic snapshots generated by scripts |
| **`content_crew`** | 5 | TMDB crew links |
| **`seasons`** | 3 | TV specific overarching seasons |
| **`user_profiles`** | 1 | Admin interface users |
| **`awards`** | 1 | Flattened Wikidata accolades |
| **`collections`** | 0 | Movie collections |

### Critical Columns (`content` table)
| Column Name | Data Type | Notes |
|---|---|---|
| `tmdb_id` | `integer` | Indexed constraint mapping to primary entity source |
| `title`, `overview`, `poster_path` | `text` | Core display properties |
| `wiki_plot`, `wiki_production` | `text` | Deep enriched text domains |
| `genres`, `production_companies` | `jsonb` | Nested structured metadata |
| `videos`, `images`, `keywords` | `jsonb` | Native media arrays |

### Foreign Key Relationships
| Source Table (Column) | target Table (Column) |
|---|---|
| `reviews.drama_id`, `discussions.drama_id`, `favorites.drama_id` | `content.id` |
| `seasons.content_id`, `episodes.content_id`, `awards.content_id` | `content.id` |
| `episodes.season_id` | `seasons.id` |
| `content.collection_id` | `collections.id` |
| `awards.person_id` | `people.id` |
| `content_cast.content_id`, `content_crew.content_id` | `content.id` |
| `content_cast.person_id`, `content_crew.person_id` | `people.id` |

### Row Level Security (RLS) Examples
| Scope | Implementation Rules |
|---|---|
| **`content`** | `is_admin()` custom function verified for ALL. Public `SELECT` allowed where `status = 'published'`. |
| **`discussions`** | Authenticated role `INSERT` qualified by `auth.uid() = user_id`. |
| **Reporting Analytics** | Many configured with full access for `service_role` (invoker bypassed). |

---

## üîÑ 3. DATA PIPELINE FLOW `[VERIFIED]`

| Stage | Process | Trigger | Action |
|---|---|---|---|
| **1. Raw Import** | `process-imports.yml` | `crons`/Manual | Grabs daily exports -> Creates `import_queue` items. |
| **2. Core Sync** | `auto-enrichment-scheduled.yml` | `crons` | Executes `npm run script:enrich-content`. Iterates over `content` fetching TMDB `/movie/{id}` with `append_to_response`. |
| **3. Extrapolation** | Multiple Scripts | Sequential | Scrapes `enrich-seasons`, `enrich-collections` relative to `content`. |
| **4. Deep Enrich** | `enrich-people.ts` | Sequential | Fetches Wikipedia -> Fetches Wikidata -> Merges + Saves to Postgres. |

> [!IMPORTANT]
> **Environment Variables Required:**
> `NEXT_PUBLIC_SUPABASE_URL`, `SUPABASE_SERVICE_ROLE_KEY`, `TMDB_ACCESS_TOKEN`, `WIKI_USER_AGENT`, `GITHUB_TOKEN`.

---

## üîå 4. EXTERNAL API INTEGRATIONS `[VERIFIED]`

| Provider | Endpoint Target | Rate Limits Enforced | Authentication |
|---|---|---|---|
| **TMDB** (`api.themoviedb.org/3`) | `/movie/{id}`, `/tv/{id}`, `/person/{id}`, `/discover/*` | `await delay(100)` explicitly placed in season scraping logic. | `TMDB_ACCESS_TOKEN` |
| **Wikipedia** (`{lang}.wikipedia.org`) | `/api/rest_v1/page/summary/{title}`, `/page/html/{title}` | Hard `RATE_LIMIT_DELAY_MS = 100` (10 req/s), satisfying Wikimedia's 200 req/sec limits. | `WIKI_USER_AGENT` |
| **Wikidata** (`query.wikidata.org`) | SPQL queries via `/sparql` | Heavy `RATE_LIMIT_DELAY_MS = 1000` (1 req/s) enforced to prevent IP blocks. | `WIKI_USER_AGENT` |

> [!NOTE]  
> Data aggregation logic relies heavily on `append_to_response` dynamically grabbing multiple data domains per single API call in TMDB to limit usage overhead.

---

## üì¶ 5. DEPENDENCIES `[VERIFIED]`

> [!TIP]
> Based on exact `package.json` configurations natively deployed.

| Package | Version | Type |
|---|---|---|
| **`next`** | 16.1.1 | Core Application |
| **`react`** / **`react-dom`** | 19.2.3 | UI Components |
| **`typescript`** | ^5 | Typing System |
| **`tailwindcss`** / `@tailwindcss/postcss` | ^4 | Styling Engine |
| **`@supabase/supabase-js`** | ^2.89.0 | Database Client |
| **`@supabase/ssr`** | ^0.8.0 | Server Auth Extensions |
| **`date-fns`** | ^4.1.0 | Date Utility |
| **`lucide-react`** | ^0.562.0 | Icon Library |
| **`tsx`** | ^4.21.0 | Script Executor Engine |

---

## üö® 6. ERROR HANDLING & MONITORING `[VERIFIED]`

| Mechanism | Component | Implementation Status |
|---|---|---|
| **Telemetry Framework** | `scripts/lib/api-logger.ts` | Intercepts Promises (`trackAPICall`) and logs metrics (`response_time_ms`, `status_code`, `error_message`) directly into `api_usage_log`. |
| **Health Verification** | `data-quality.yml` | Cron checks nulls natively to log report cards into `quality_reports`. |
| **Retry Mechanics** | `enrichment_queue` | Logic attempts sequential drops via its own table mechanics. |
| **External Alerting** | Webhooks/Sentry | `[UNKNOWN]` No Sentry packages or Webhook libraries were discovered natively. GitHub action natively sends fail email to author. |

---

## üîê 7. SECURITY `[VERIFIED]`

| Security Feature | Implementation | Status |
|---|---|---|
| **Secret Injectors** | Selectively injected at step-level in GitHub workflows via `${{ secrets.TMDB_ACCESS_TOKEN }}`. | `[VERIFIED]` |
| **Local Environment** | `.env.local` runs `dotenvx` to map local variables securely outside repository memory. | `[VERIFIED]` |
| **Hardcoded Credentials** | Readings of script wrappers revealed `$env` variables injected cleanly via script `process.env`. | `[VERIFIED ABSENT]` |
| **Key Rotations** | Strategy is externalized to GitHub Actions architecture (Not observed natively inside source code). | `[UNKNOWN]` |
