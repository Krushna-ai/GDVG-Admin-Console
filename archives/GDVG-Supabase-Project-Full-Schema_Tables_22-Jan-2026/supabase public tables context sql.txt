-- WARNING: This schema is for context only and is not meant to be run.
-- Table order and constraints may not be valid for execution.

CREATE TABLE public.activities (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  activity_type character varying,
  drama_id uuid,
  review_id uuid,
  message text,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT activities_pkey PRIMARY KEY (id),
  CONSTRAINT activities_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id),
  CONSTRAINT activities_drama_id_fkey FOREIGN KEY (drama_id) REFERENCES public.dramas(id)
);
CREATE TABLE public.actors (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  name character varying NOT NULL,
  profile_image_url text,
  bio text,
  birth_date date,
  nationality character varying,
  gender character varying,
  popularity_score numeric DEFAULT 0.00,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT actors_pkey PRIMARY KEY (id)
);
CREATE TABLE public.admin_users (
  id uuid NOT NULL,
  email text NOT NULL UNIQUE,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT admin_users_pkey PRIMARY KEY (id),
  CONSTRAINT admin_users_id_fkey FOREIGN KEY (id) REFERENCES auth.users(id)
);
CREATE TABLE public.ai_batches (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  batch_number integer NOT NULL,
  item_count integer NOT NULL,
  status text NOT NULL CHECK (status = ANY (ARRAY['PENDING_REVIEW'::text, 'APPROVED'::text, 'REJECTED'::text, 'PUBLISHED'::text])),
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_batches_pkey PRIMARY KEY (id)
);
CREATE TABLE public.ai_logs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  action text NOT NULL,
  actor text NOT NULL CHECK (actor = ANY (ARRAY['AI'::text, 'HUMAN'::text])),
  details text,
  timestamp timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_logs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.ai_pending_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  batch_id text,
  type text NOT NULL CHECK (type = ANY (ARRAY['DRAMA'::text, 'PERSON'::text, 'EPISODE'::text])),
  json_data jsonb NOT NULL,
  confidence integer NOT NULL DEFAULT 75 CHECK (confidence >= 0 AND confidence <= 100),
  status text NOT NULL DEFAULT 'PENDING'::text CHECK (status = ANY (ARRAY['PENDING'::text, 'APPROVED'::text, 'REJECTED'::text])),
  created_at timestamp with time zone DEFAULT now(),
  job_id uuid,
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT ai_pending_queue_pkey PRIMARY KEY (id)
);
CREATE TABLE public.app_users (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  email text NOT NULL UNIQUE,
  username text NOT NULL UNIQUE,
  password_hash text NOT NULL,
  first_name text NOT NULL,
  last_name text NOT NULL,
  avatar_url text,
  bio text,
  location text,
  is_verified boolean NOT NULL DEFAULT false,
  is_active boolean NOT NULL DEFAULT true,
  joined_date timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  last_login timestamp with time zone,
  preferences jsonb DEFAULT '{}'::jsonb,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT app_users_pkey PRIMARY KEY (id)
);
CREATE TABLE public.audit_log (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  table_name text NOT NULL,
  record_id text NOT NULL,
  action text NOT NULL,
  old_values jsonb,
  new_values jsonb,
  actor_id uuid NOT NULL,
  actor_email text,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  reason text,
  CONSTRAINT audit_log_pkey PRIMARY KEY (id)
);
CREATE TABLE public.content (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tmdb_id integer NOT NULL UNIQUE,
  imdb_id text,
  content_type text NOT NULL CHECK (content_type = ANY (ARRAY['movie'::text, 'tv'::text])),
  title text NOT NULL,
  original_title text,
  overview text,
  poster_path text,
  backdrop_path text,
  release_date date,
  first_air_date date,
  status text DEFAULT 'draft'::text CHECK (status = ANY (ARRAY['draft'::text, 'published'::text, 'archived'::text])),
  original_language text,
  origin_country ARRAY,
  genres jsonb,
  popularity numeric,
  vote_average numeric,
  vote_count integer,
  runtime integer,
  number_of_seasons integer,
  number_of_episodes integer,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT content_pkey PRIMARY KEY (id)
);
CREATE TABLE public.content_cast (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  content_id uuid NOT NULL,
  person_id uuid NOT NULL,
  character_name text,
  order_index integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT content_cast_pkey PRIMARY KEY (id),
  CONSTRAINT content_cast_content_id_fkey FOREIGN KEY (content_id) REFERENCES public.content(id),
  CONSTRAINT content_cast_person_id_fkey FOREIGN KEY (person_id) REFERENCES public.people(id)
);
CREATE TABLE public.content_crew (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  content_id uuid NOT NULL,
  person_id uuid NOT NULL,
  job text NOT NULL,
  department text,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT content_crew_pkey PRIMARY KEY (id),
  CONSTRAINT content_crew_content_id_fkey FOREIGN KEY (content_id) REFERENCES public.content(id),
  CONSTRAINT content_crew_person_id_fkey FOREIGN KEY (person_id) REFERENCES public.people(id)
);
CREATE TABLE public.discussions (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  drama_id uuid NOT NULL,
  user_id uuid NOT NULL,
  title text NOT NULL,
  body text NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT discussions_pkey PRIMARY KEY (id),
  CONSTRAINT discussions_drama_id_fkey FOREIGN KEY (drama_id) REFERENCES public.dramas(id),
  CONSTRAINT discussions_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.drama_cast (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  drama_id uuid,
  actor_id uuid,
  character_name character varying,
  role_type character varying CHECK (role_type::text = ANY (ARRAY['main'::character varying, 'supporting'::character varying, 'guest'::character varying, 'cameo'::character varying]::text[])),
  display_order integer,
  CONSTRAINT drama_cast_pkey PRIMARY KEY (id),
  CONSTRAINT drama_cast_drama_id_fkey FOREIGN KEY (drama_id) REFERENCES public.dramas(id),
  CONSTRAINT drama_cast_actor_id_fkey FOREIGN KEY (actor_id) REFERENCES public.actors(id)
);
CREATE TABLE public.drama_crew (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  drama_id uuid NOT NULL,
  person_tmdb_id integer NOT NULL,
  person_name text NOT NULL,
  job text NOT NULL,
  department text,
  profile_path text,
  gender integer,
  created_at timestamp with time zone DEFAULT now(),
  CONSTRAINT drama_crew_pkey PRIMARY KEY (id),
  CONSTRAINT drama_crew_drama_id_fkey FOREIGN KEY (drama_id) REFERENCES public.dramas(id)
);
CREATE TABLE public.drama_people_link (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  drama_id uuid NOT NULL,
  person_id bigint NOT NULL,
  role_type text NOT NULL,
  character_name text,
  billing_order integer,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  created_by uuid,
  CONSTRAINT drama_people_link_pkey PRIMARY KEY (id),
  CONSTRAINT drama_people_link_drama_id_fkey FOREIGN KEY (drama_id) REFERENCES public.dramas(id),
  CONSTRAINT drama_people_link_created_by_fkey FOREIGN KEY (created_by) REFERENCES auth.users(id)
);
CREATE TABLE public.dramas (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  title character varying NOT NULL,
  original_title character varying,
  synopsis text,
  poster_url text,
  banner_url text,
  trailer_url text,
  country character varying,
  language character varying,
  genre ARRAY,
  year integer,
  episodes_total integer DEFAULT 0,
  seasons_total integer DEFAULT 1,
  duration_minutes integer,
  rating numeric DEFAULT 0.0,
  vote_count integer DEFAULT 0,
  status character varying,
  release_date date,
  end_date date,
  streaming_platforms ARRAY,
  director ARRAY DEFAULT '{}'::text[],
  writer ARRAY DEFAULT '{}'::text[],
  network character varying,
  view_count integer DEFAULT 0,
  popularity_score numeric DEFAULT 0.00,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  category text DEFAULT 'Series'::text CHECK (category = ANY (ARRAY['MOVIE'::text, 'DRAMA'::text, 'VERTICAL'::text, 'SERIES'::text])),
  episodes integer,
  content_rating text,
  native_title text,
  runtime text,
  external_links jsonb DEFAULT '{}'::jsonb,
  cast_members ARRAY,
  genres ARRAY DEFAULT '{}'::text[],
  platforms ARRAY DEFAULT '{}'::text[],
  emotional_tags ARRAY DEFAULT '{}'::text[],
  video_url text,
  streaming_sources jsonb DEFAULT '[]'::jsonb,
  synopsis_detailed text,
  slug text,
  wikidata_id text,
  alternative_titles ARRAY,
  romanization text,
  composers ARRAY,
  producers ARRAY,
  editors ARRAY,
  cinematographers ARRAY,
  production_companies ARRAY,
  based_on_work text,
  original_author text,
  awards text,
  highest_viewership text,
  source_id text,
  source_type text,
  deprecated_at timestamp with time zone,
  deprecated_by uuid,
  CONSTRAINT dramas_pkey PRIMARY KEY (id),
  CONSTRAINT dramas_deprecated_by_fkey FOREIGN KEY (deprecated_by) REFERENCES auth.users(id)
);
CREATE TABLE public.dramas_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  title_en text NOT NULL,
  title_ko text,
  wikidata_id text,
  network text,
  status text,
  episode_count integer,
  start_date date,
  end_date date,
  director text,
  screenwriter text,
  cast_members text,
  production_company text,
  image_url text,
  trailer_url text,
  queue_status text DEFAULT 'PENDING_ENRICHMENT'::text CHECK (queue_status = ANY (ARRAY['PENDING_ENRICHMENT'::text, 'ENRICHED'::text, 'PROCESSING'::text, 'COMPLETED'::text, 'ERROR'::text])),
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  enrichment_data jsonb,
  enrichment_score integer,
  CONSTRAINT dramas_queue_pkey PRIMARY KEY (id)
);
CREATE TABLE public.episodes (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  drama_id uuid,
  season_number integer DEFAULT 1,
  episode_number integer NOT NULL,
  title character varying,
  synopsis text,
  air_date date,
  duration_minutes integer,
  still_image_url text,
  view_count integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT episodes_pkey PRIMARY KEY (id),
  CONSTRAINT episodes_drama_id_fkey FOREIGN KEY (drama_id) REFERENCES public.dramas(id)
);
CREATE TABLE public.favorites (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  user_id uuid NOT NULL,
  drama_id uuid NOT NULL,
  status text DEFAULT 'Plan to Watch'::text,
  progress integer DEFAULT 0,
  score integer DEFAULT 0,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT favorites_pkey PRIMARY KEY (id),
  CONSTRAINT favorites_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id),
  CONSTRAINT favorites_drama_id_fkey FOREIGN KEY (drama_id) REFERENCES public.dramas(id)
);
CREATE TABLE public.follows (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  follower_id uuid,
  following_id uuid,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT follows_pkey PRIMARY KEY (id),
  CONSTRAINT follows_follower_id_fkey FOREIGN KEY (follower_id) REFERENCES public.user_profiles(id),
  CONSTRAINT follows_following_id_fkey FOREIGN KEY (following_id) REFERENCES public.user_profiles(id)
);
CREATE TABLE public.import_jobs (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  admin_username text NOT NULL,
  source_type text NOT NULL,
  source text NOT NULL,
  status text NOT NULL,
  total_rows integer NOT NULL DEFAULT 0,
  processed_rows integer NOT NULL DEFAULT 0,
  successful_imports integer NOT NULL DEFAULT 0,
  failed_imports integer NOT NULL DEFAULT 0,
  errors jsonb DEFAULT '[]'::jsonb,
  started_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  finished_at timestamp with time zone,
  CONSTRAINT import_jobs_pkey PRIMARY KEY (id)
);
CREATE TABLE public.import_queue (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tmdb_id integer NOT NULL,
  content_type text NOT NULL CHECK (content_type = ANY (ARRAY['movie'::text, 'tv'::text])),
  priority integer DEFAULT 0,
  status text DEFAULT 'pending'::text CHECK (status = ANY (ARRAY['pending'::text, 'processing'::text, 'completed'::text, 'failed'::text, 'skipped'::text])),
  batch_name text,
  release_year integer,
  release_month integer,
  error_message text,
  attempts integer DEFAULT 0,
  created_at timestamp with time zone DEFAULT now(),
  processed_at timestamp with time zone,
  CONSTRAINT import_queue_pkey PRIMARY KEY (id)
);
CREATE TABLE public.ingestion_tasks (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  content_type text NOT NULL DEFAULT 'tv'::text CHECK (content_type = ANY (ARRAY['tv'::text, 'movie'::text, 'person'::text])),
  content_id integer NOT NULL,
  round text NOT NULL CHECK (round = ANY (ARRAY['CORE'::text, 'CREDITS'::text, 'PEOPLE'::text, 'MEDIA'::text, 'SEASONS'::text])),
  status text NOT NULL DEFAULT 'PENDING'::text CHECK (status = ANY (ARRAY['PENDING'::text, 'RUNNING'::text, 'COMPLETE'::text, 'FAILED'::text, 'SKIPPED'::text])),
  priority integer NOT NULL DEFAULT 100,
  depends_on uuid,
  result_data jsonb,
  error_code text,
  error_message text,
  created_by uuid,
  created_at timestamp with time zone NOT NULL DEFAULT now(),
  updated_at timestamp with time zone NOT NULL DEFAULT now(),
  CONSTRAINT ingestion_tasks_pkey PRIMARY KEY (id),
  CONSTRAINT ingestion_tasks_depends_on_fkey FOREIGN KEY (depends_on) REFERENCES public.ingestion_tasks(id)
);
CREATE TABLE public.people (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  tmdb_id integer NOT NULL UNIQUE,
  name text NOT NULL,
  gender integer,
  biography text,
  birthday date,
  deathday date,
  place_of_birth text,
  profile_path text,
  known_for_department text,
  popularity numeric,
  imdb_id text,
  created_at timestamp with time zone DEFAULT now(),
  updated_at timestamp with time zone DEFAULT now(),
  CONSTRAINT people_pkey PRIMARY KEY (id)
);
CREATE TABLE public.review_votes (
  id uuid NOT NULL DEFAULT gen_random_uuid(),
  review_id uuid NOT NULL,
  user_id text NOT NULL,
  helpful boolean NOT NULL,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT review_votes_pkey PRIMARY KEY (id)
);
CREATE TABLE public.reviews (
  id bigint GENERATED ALWAYS AS IDENTITY NOT NULL,
  drama_id uuid NOT NULL,
  user_id uuid NOT NULL,
  user_email text,
  rating integer CHECK (rating >= 1 AND rating <= 10),
  comment text,
  created_at timestamp with time zone NOT NULL DEFAULT timezone('utc'::text, now()),
  CONSTRAINT reviews_pkey PRIMARY KEY (id),
  CONSTRAINT reviews_drama_id_fkey FOREIGN KEY (drama_id) REFERENCES public.dramas(id),
  CONSTRAINT reviews_user_id_fkey FOREIGN KEY (user_id) REFERENCES auth.users(id)
);
CREATE TABLE public.user_profiles (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  email character varying UNIQUE,
  username character varying NOT NULL UNIQUE,
  display_name character varying,
  avatar_url text,
  bio text,
  country character varying,
  preferred_languages ARRAY,
  favorite_genres ARRAY,
  joined_date timestamp with time zone DEFAULT timezone('utc'::text, now()),
  last_active timestamp with time zone DEFAULT timezone('utc'::text, now()),
  follower_count integer DEFAULT 0,
  following_count integer DEFAULT 0,
  reviews_count integer DEFAULT 0,
  watchlist_count integer DEFAULT 0,
  is_premium boolean DEFAULT false,
  is_verified boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  CONSTRAINT user_profiles_pkey PRIMARY KEY (id)
);
CREATE TABLE public.watchlist (
  id uuid NOT NULL DEFAULT uuid_generate_v4(),
  user_id uuid,
  drama_id uuid,
  status character varying CHECK (status::text = ANY (ARRAY['watching'::character varying, 'plan_to_watch'::character varying, 'completed'::character varying, 'dropped'::character varying, 'on_hold'::character varying]::text[])),
  progress integer DEFAULT 0,
  score numeric,
  start_date date,
  finish_date date,
  notes text,
  is_favorite boolean DEFAULT false,
  created_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  updated_at timestamp with time zone DEFAULT timezone('utc'::text, now()),
  content_id uuid,
  total_episodes integer,
  CONSTRAINT watchlist_pkey PRIMARY KEY (id),
  CONSTRAINT watchlist_user_id_fkey FOREIGN KEY (user_id) REFERENCES public.user_profiles(id),
  CONSTRAINT watchlist_drama_id_fkey FOREIGN KEY (drama_id) REFERENCES public.dramas(id)
);